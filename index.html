<!DOCTYPE html>
<html lang="lt" class="dark">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Sirvydo Žodynas – Chatbot</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-900 text-gray-200 min-h-screen flex flex-col relative">

    <!-- CHAT WINDOW -->
    <div id="chatbox" class="flex-1 overflow-y-auto p-4 space-y-4 pb-28"></div>

    <!-- INPUT BAR FIXED BOTTOM -->
    <div class="fixed bottom-0 left-0 right-0 bg-gray-800 border-t border-gray-700 p-3 flex items-center gap-2">
        <input id="userQuestion" type="text" placeholder="Rašykite klausimą…" class="flex-1 p-3 rounded-lg bg-gray-700 text-gray-100 focus:outline-none">
        <button id="sendBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-5 py-3 rounded-lg">Siųsti</button>
    </div>

    <script>
        const chatbox = document.getElementById("chatbox");
        const userInput = document.getElementById("userQuestion");
        const sendBtn = document.getElementById("sendBtn");

        // ANIMUOTAS AVATARAS (SVG)
        const sirvydasAvatar = `
            <svg width="36" height="36" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="animate-pulse">
              <circle cx="12" cy="12" r="10" />
              <circle cx="12" cy="10" r="3" />
              <path d="M7 20c1-4 9-4 10 0" />
            </svg>
        `;

        // VARTOTOJO AVATARAS
        const userAvatar = `
            <div class="w-9 h-9 bg-blue-600 rounded-full grid place-content-center text-white font-bold">V</div>
        `;

        // ISTORIJOS IŠSAUGOJIMAS
        function saveHistory() {
            localStorage.setItem("sirvydas_history", chatbox.innerHTML);
        }
        function loadHistory() {
            const history = localStorage.getItem("sirvydas_history");
            if (history) chatbox.innerHTML = history;
        }
        loadHistory();

        // RAŠYMO ANIMACIJA (letter-by-letter)
        async function typeWriterEffect(element, text, speed = 15) {
            for (let i = 0; i < text.length; i++) {
                element.innerHTML += text[i];
                await new Promise(res => setTimeout(res, speed));
            }
        }

        function addMessage(text, sender) {
            const wrapper = document.createElement("div");
            wrapper.className = `flex items-start gap-3 ${sender === 'user' ? 'justify-end' : ''}`;

            const bubble = document.createElement("div");
            bubble.className = `max-w-[75%] p-3 rounded-xl shadow-md leading-relaxed ${
                sender === 'user'
                    ? 'bg-blue-600 text-white rounded-br-none'
                    : 'bg-gray-800 text-gray-100 rounded-bl-none'
            }`;

            const avatar = document.createElement("div");
            avatar.innerHTML = sender === 'user' ? userAvatar : sirvydasAvatar;

            if (sender === "user") {
                wrapper.appendChild(bubble);
                wrapper.appendChild(avatar);
                bubble.textContent = text;
                saveHistory();
                return;
            }

            wrapper.appendChild(avatar);
            wrapper.appendChild(bubble);
            chatbox.appendChild(wrapper);
            chatbox.scrollTop = chatbox.scrollHeight;

            typeWriterEffect(bubble, text).then(saveHistory);
        }

        async function sendMessage() {
            const question = userInput.value.trim();
            if (!question) return;

            addMessage(question, "user");
            userInput.value = "";

            addMessage("…", "bot");

            try {
                const response = await fetch("/api/chatbot", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ prompt: question })
                });

                const data = await response.json();
                const last = chatbox.lastChild.querySelector('div:nth-child(2)');
                last.innerHTML = "";

                if (!data.answer) {
                    typeWriterEffect(last, "⚠ Įvyko klaida. Patikrinkite API atsakymą.");
                    return;
                }

                typeWriterEffect(last, data.answer);

            } catch (err) {
                console.error(err);
                const last = chatbox.lastChild.querySelector('div:nth-child(2)');
                last.innerHTML = "";
                typeWriterEffect(last, "⚠ Nepavyko susisiekti su serveriu.");
            }
        }

        sendBtn.addEventListener("click", sendMessage);
        userInput.addEventListener("keydown", (e) => {
            if (e.key === "Enter") sendMessage();
        });
    </script>
</body>
</html>
